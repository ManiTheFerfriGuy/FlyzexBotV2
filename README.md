# FlyzexBot

FlyzexBot یک ربات تلگرامی با رابط شیشه‌ای است که مدیریت یک گیلد و گروه را آسان می‌کند. این ربات با استفاده از `python-telegram-bot` (نسخه‌ی ناهمگام) توسعه داده شده و شامل بخش درخواست عضویت، مدیریت ادمین‌ها، لیدربورد تجربه (XP) و جام‌ها (Cups) است. تمامی پیام‌ها و رابط‌های تعاملی به زبان فارسی طراحی شده‌اند.

## قابلیت‌ها
- **بخش خصوصی (DM):**
  - ارائه‌ی فرم «درخواست عضویت در گیلد» با رابط شیشه‌ای.
  - امکان بررسی و تأیید/رد درخواست‌ها برای ادمین‌ها.
  - اعلان نتیجه‌ی درخواست (قبولی یا رد).
- **بخش گروه:**
  - سیستم XP خودکار بر اساس فعالیت اعضا در گروه.
  - پیام‌های ارسال شده توسط ربات‌های کمکی نادیده گرفته می‌شوند تا امتیاز اضافه نگیرند.
  - لیدربورد جام‌ها با قابلیت افزودن جام جدید توسط ادمین‌ها.
  - اعضا تنها می‌توانند لیدربوردها را مشاهده کنند.
- **امنیت و نگه‌داری:**
  - رمزنگاری داده‌های حساس با استفاده از Fernet.
  - محدودسازی نرخ پیام‌ها، لاگ‌گیری و مدیریت استثناء.
  - تست‌های واحد برای ماژول‌های کلیدی.

## راه‌اندازی
1. وابستگی‌ها را نصب کنید:
   ```bash
   pip install -r requirements.txt
   ```
2. فایل `config/settings.example.yaml` را به `config/settings.yaml` کپی کرده و تنظیمات را مطابق نیاز تغییر دهید.
3. متغیرهای محیطی `BOT_TOKEN` و `BOT_SECRET_KEY` را مقداردهی کنید.
4. ربات را اجرا کنید:
   ```bash
   python bot.py
   ```

## اجرای WebApp مدیریتی
این مخزن شامل یک WebApp سبک بر پایه FastAPI است که وضعیت ذخیره‌سازی ربات را نمایش می‌دهد (درخواست‌های معلق، لیدربورد XP و جام‌ها).

1. تمام وابستگی‌ها (از جمله `fastapi` و `uvicorn`) در فایل `requirements.txt` ذکر شده‌اند. اطمینان حاصل کنید که پس از به‌روزرسانی وابستگی‌ها، محیط مجازی خود را دوباره نصب/به‌روزرسانی کرده‌اید.
2. تنظیمات سرور وب از بخش `webapp` در `config/settings.yaml` خوانده می‌شود. این تنظیمات شامل `host`، `port` و در صورت نیاز `url` عمومی است.
3. برای اجرای WebApp به صورت همزمان با ربات، دو فرایند جداگانه اجرا کنید (در ترمینال‌های مختلف یا با ابزارهایی مانند `tmux`, `systemd` یا `supervisor`):
   ```bash
   # ترمینال اول: اجرای ربات
   python bot.py

   # ترمینال دوم: اجرای سرویس وب
   uvicorn webapp.server:app --host 0.0.0.0 --port 8080
   ```
   مقادیر `host` و `port` را مطابق تنظیمات خود تغییر دهید. WebApp همان فایل ذخیره‌سازی رمزنگاری‌شده ربات را می‌خواند؛ بنابراین متغیر محیطی `BOT_SECRET_KEY` (یا متغیر معرفی‌شده در پیکربندی) باید در هر دو فرایند مقداردهی شده باشد.
4. در محیط تولید، توصیه می‌شود WebApp پشت یک Reverse Proxy مانند Nginx سرو شود. برای جلوگیری از افشای اطلاعات حساس:
   - دسترسی را به مدیران محدود کنید (مثلاً با Basic Auth، OAuth، یا محدودسازی IP).
   - در صورت استفاده از WebApp به عنوان WebView تلگرام، از توکن تأیید (`tgWebAppData`) برای صحت‌سنجی کاربر نهایی استفاده کنید.
   - در حالت ایده‌آل، سرویس وب فقط روی شبکه داخلی یا VPN دردسترس باشد.

پس از اجرا می‌توانید از طریق مرورگر یا WebView تلگرام به آدرس مشخص‌شده مراجعه کنید. رابط کاربری موجود در `webapp/index.html` دکمه‌هایی برای مشاهده داده‌های API جدید (`/api/applications/pending`، `/api/xp` و `/api/cups`) دارد و همه درخواست‌ها را به صورت زنده رندر می‌کند.

## تست‌ها
```bash
pytest
```

## استقرار
- می‌توانید از پلتفرم‌هایی مانند Heroku، AWS یا DigitalOcean برای استقرار استفاده کنید.
- با تنظیم متغیرهای محیطی و فعال‌سازی به‌روزرسانی خودکار (CI/CD) می‌توانید فرآیند نگه‌داری را ساده کنید.

