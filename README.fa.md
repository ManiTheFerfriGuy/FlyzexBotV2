# فلایزکس‌بات

فلایزکس‌بات یک ربات تلگرام با رابط شیشه‌ای (Glassmorphism) است که مدیریت درخواست‌های عضویت، امتیاز تجربه (XP) و جدول جام‌ها را برای مدیران گیلد و گروه آسان می‌کند. این پروژه با نسخهٔ ناهمگام کتابخانهٔ `python-telegram-bot` توسعه داده شده و یک وب‌اپلیکیشن سبک بر پایهٔ FastAPI نیز برای مشاهدهٔ داده‌های ذخیره‌شده در اختیار شما قرار می‌دهد.

## فهرست مطالب
- [قابلیت‌ها](#قابلیت‌ها)
- [نمای کلی معماری](#نمای-کلی-معماری)
- [شروع سریع](#شروع-سریع)
  - [پیش‌نیازها](#پیش‌نیازها)
  - [نصب](#نصب)
  - [پیکربندی](#پیکربندی)
- [اجرای ربات](#اجرای-ربات)
- [اجرای وب‌اپ مدیریتی](#اجرای-وب‌اپ-مدیریتی)
- [تست‌ها](#تست‌ها)
- [نکات استقرار](#نکات-استقرار)
- [ساختار پروژه](#ساختار-پروژه)

## قابلیت‌ها
### بخش خصوصی (Direct Message)
- جمع‌آوری درخواست‌های عضویت در گیلد با رابط شیشه‌ای و فرم تعاملی.
- امکان بررسی، تأیید یا رد درخواست‌ها توسط ادمین‌ها.
- اطلاع‌رسانی نتیجهٔ نهایی به متقاضیان.

### بخش گروه
- سیستم XP خودکار بر اساس فعالیت اعضا در گروه.
- نادیده گرفتن پیام‌های ربات‌های کمکی برای جلوگیری از امتیازدهی ناعادلانه.
- لیدربورد جام‌ها با امکان ایجاد جام جدید توسط ادمین‌ها.
- اعضا تنها امکان مشاهدهٔ لیدربوردها را دارند و نمی‌توانند تغییری ایجاد کنند.
- دستور `/help` یک برگهٔ تقلب درون‌گروهی می‌دهد و `/myxp` امتیاز شخصی هر عضو را نمایش می‌دهد.
- پنل شیشه‌ای `/panel` آمار لحظه‌ای گروه و دکمه‌های مدیریتی سریع را در اختیار ادمین قرار می‌دهد.

### امنیت و پایداری
- ذخیره‌سازی JSON با امکان تهیهٔ نسخهٔ پشتیبان SQLite.
- محدودسازی نرخ، لاگ‌گیری و مدیریت استثنا برای افزایش پایداری.
- تست‌های واحد برای ماژول‌های حیاتی.

## نمای کلی معماری
```
FlyzexBotV2/
├─ bot.py                # نقطهٔ ورود ربات تلگرام
├─ flyzexbot/            # منطق اصلی ربات و هندلرها
├─ webapp/               # وب‌اپ FastAPI برای نمایش داده‌ها
├─ config/settings.yaml  # تنظیمات زمان اجرا (کپی از مثال)
└─ cachetools/           # ابزارهای کش مورد استفادهٔ ربات
```

ربات و وب‌اپلیکیشن از لایهٔ ذخیره‌سازی مشترکی استفاده می‌کنند تا مدیران بتوانند درخواست‌های معلق و لیدربوردها را خارج از تلگرام نیز بررسی کنند.

## شروع سریع
### پیش‌نیازها
- پایتون 3.10 یا بالاتر
- توکن ربات تلگرام
- (اختیاری) کلید API برای کنترل دسترسی به وب‌اپ مدیریتی

### نصب
```bash
pip install -r requirements.txt
```

### پیکربندی
1. فایل `config/settings.example.yaml` را به `config/settings.yaml` کپی کرده و مقادیر را مطابق نیاز خود تغییر دهید.
2. متغیرهای محیطی زیر را تنظیم کنید:
   - `BOT_TOKEN`: توکن ربات تلگرام
   - `ADMIN_API_KEY`: کلید دسترسی به API مدیریتی وب‌اپ (اختیاری)

## اجرای ربات
```bash
python bot.py
```

فایل ذخیره‌سازی که در `config/settings.yaml` تعریف شده (به طور پیش‌فرض `data/storage.json`) یک سند JSON با رمزگذاری UTF-8 است و می‌توانید آن را با هر ویرایشگر متنی باز کنید.

## اجرای وب‌اپ مدیریتی
این مخزن شامل وب‌اپلیکیشن FastAPI است که درخواست‌های معلق، لیدربورد XP و لیدربورد جام‌ها را نمایش می‌دهد.

1. وابستگی‌ها را نصب کنید (همهٔ موارد در `requirements.txt` آمده‌اند).
2. در فایل `config/settings.yaml` بخش مربوط به `webapp` را تنظیم کنید (`host`، `port` و در صورت نیاز `url` عمومی).
3. ربات و وب‌سرور را در دو فرایند جداگانه اجرا کنید:
   ```bash
   # ترمینال اول
   python bot.py

   # ترمینال دوم
   uvicorn webapp.server:app --host 0.0.0.0 --port 8080
   ```
4. در محیط تولید، وب‌اپ را پشت یک Reverse Proxy (مثلاً Nginx) قرار دهید و دسترسی را با احراز هویت یا محدودسازی شبکه کنترل کنید.

رابط کاربری پیش‌فرض (`webapp/index.html`) شامل پیوندهای سریع به آدرس‌های زیر است:
- `/api/applications/pending`
- `/api/xp`
- `/api/cups`

این APIها داده‌های زنده را برای نمایش در رابط فراهم می‌کنند.

## تست‌ها
```bash
pytest
```

## نکات استقرار
- از پلتفرم‌هایی مانند Heroku، AWS یا DigitalOcean برای میزبانی استفاده کنید.
- متغیرهای محیطی را تنظیم کرده و با راه‌اندازی CI/CD به‌روزرسانی خودکار را فعال کنید.
- کلید API مدیریتی را محرمانه نگه‌دارید و در صورت نیاز آن را به‌صورت امن جابه‌جا یا جایگزین کنید.

## ساختار پروژه
```
FlyzexBotV2/
├─ README.md
├─ README.en.md
├─ README.fa.md
├─ bot.py
├─ config/
├─ flyzexbot/
├─ tests/
└─ webapp/
```
