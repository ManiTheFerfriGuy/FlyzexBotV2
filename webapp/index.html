<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Flyzex Leaderboards</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="static/glass_panel.css" />
    <style>
      :root {
        --ease-spring: cubic-bezier(.16, 1, .3, 1);
        --badge: linear-gradient(135deg, #5b8dfd, #9b6bff);
        --card-layer: rgba(16, 24, 48, .84);
        --card-border-strong: rgba(148, 163, 184, .28);
        --chip-bg: rgba(148, 163, 184, .16);
        --chip-border: rgba(148, 163, 184, .28);
        --chip-text: rgba(218, 229, 255, .82);
        --muted: rgba(203, 213, 225, .76);
        --glow: rgba(91, 141, 253, .35);
      }

      .app-shell {
        grid-template-columns: 1fr;
        padding: clamp(.35rem, 1.5vw, .7rem);
      }

      .main-content {
        width: min(420px, 100%);
        margin-inline: auto;
        background: linear-gradient(160deg, rgba(14, 21, 42, .94), rgba(11, 18, 36, .86));
        border-radius: 26px;
        border: 1px solid rgba(148, 163, 184, .18);
        box-shadow: 0 28px 70px rgba(3, 8, 23, .55);
        padding: clamp(1.1rem, 4vw, 1.6rem);
        gap: clamp(1.15rem, 3vw, 1.55rem);
        position: relative;
        overflow: hidden;
      }

      .main-content::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 78% -15%, rgba(91, 141, 253, .16), transparent 60%),
          radial-gradient(circle at 12% 110%, rgba(56, 189, 248, .18), transparent 62%);
        pointer-events: none;
        z-index: -1;
      }

      .hero {
        display: grid;
        gap: .6rem;
        justify-items: center;
        text-align: center;
        animation: fadeIn .55s var(--ease-spring) both;
      }

      .hero > div { display: grid; gap: .35rem; }

      .page-header h2 { margin: 0; font-size: clamp(1.35rem, 4vw, 1.85rem); letter-spacing: .015em; }

      .page-header p { margin: 0; font-size: .95rem; color: var(--muted); }

      .switcher {
        display: flex;
        gap: .5rem;
        padding: .35rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, .04);
        border: 1px solid rgba(148, 163, 184, .22);
        box-shadow: 0 18px 38px rgba(5, 11, 30, .45);
        width: min(100%, 360px);
        margin-inline: auto;
      }

      .switch-btn {
        flex: 1 1 auto;
        border: none;
        background: transparent;
        color: inherit;
        padding: .55rem .9rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: .92rem;
        font-weight: 600;
        letter-spacing: .01em;
        font-family: "Plus Jakarta Sans", "Vazirmatn", sans-serif;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .35rem;
        transition: transform .25s var(--ease-spring), background .28s var(--ease-spring), color .28s var(--ease-spring), box-shadow .28s var(--ease-spring);
      }

      .switch-btn:hover { transform: translateY(-1px); }

      .switch-btn:focus-visible {
        outline: none;
        transform: translateY(-1px);
        box-shadow: 0 0 0 3px rgba(91, 141, 253, .55);
      }

      .switch-btn.active {
        background: var(--badge);
        color: #0f172a;
        box-shadow: 0 16px 32px rgba(91, 141, 253, .4);
      }

      .switch-btn.active:focus-visible {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, .55), 0 16px 32px rgba(91, 141, 253, .4);
      }

      .item-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .leader-list {
        display: grid;
        gap: clamp(.8rem, 2.5vw, 1rem);
      }

      .data-card {
        position: relative;
        background: var(--card-layer);
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, .16);
        padding: clamp(1rem, 3.5vw, 1.35rem);
        box-shadow: 0 22px 45px rgba(5, 10, 28, .45);
        display: grid;
        gap: clamp(1rem, 3vw, 1.25rem);
        isolation: isolate;
        overflow: hidden;
        animation: rise .55s var(--ease-spring) both;
      }

      .data-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 12% -20%, rgba(148, 163, 254, .16), transparent 60%);
        pointer-events: none;
        z-index: -1;
      }

      .data-card:nth-of-type(2) { animation-delay: .1s; }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: .75rem;
      }

      .card-header h3 { margin: 0; font-size: clamp(1.08rem, 3.4vw, 1.3rem); letter-spacing: .015em; }

      .icon-button {
        border-color: rgba(148, 163, 184, .32);
        background: linear-gradient(135deg, rgba(148, 163, 184, .18), rgba(91, 141, 253, .2));
      }

      .icon-button:hover,
      .icon-button:focus-visible {
        transform: translateY(-1px) rotate(-8deg);
        box-shadow: 0 16px 32px rgba(91, 141, 253, .28);
      }

      .leader {
        position: relative;
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: clamp(.85rem, 2.5vw, 1.1rem);
        padding: clamp(.9rem, 3vw, 1.1rem) clamp(.85rem, 3vw, 1.2rem);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, .2);
        background: linear-gradient(130deg, rgba(15, 24, 45, .82), rgba(20, 30, 55, .72));
        box-shadow: 0 18px 38px rgba(5, 10, 28, .4);
        transition: border-color .25s var(--ease-spring), transform .25s var(--ease-spring), box-shadow .25s var(--ease-spring), background .25s var(--ease-spring);
      }

      .leader::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: radial-gradient(circle at 15% 15%, rgba(91, 141, 253, .2), transparent 65%);
        opacity: 0;
        transition: opacity .25s var(--ease-spring);
        pointer-events: none;
      }

      .leader:hover,
      .leader:focus-within {
        transform: translateY(-3px);
        border-color: var(--card-border-strong);
        box-shadow: 0 24px 42px rgba(5, 12, 32, .45);
      }

      .leader:hover::after,
      .leader:focus-within::after { opacity: 1; }

      .leader.preview {
        opacity: .68;
        filter: saturate(.85);
        pointer-events: none;
      }

      .portrait {
        position: relative;
        display: grid;
        place-items: center;
        padding-inline-end: .3rem;
      }

      .avatar {
        width: 3.2rem;
        height: 3.2rem;
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(91, 141, 253, .24), rgba(45, 212, 191, .16));
        display: grid;
        place-items: center;
        overflow: hidden;
        box-shadow: 0 12px 30px rgba(4, 9, 24, .45);
        color: #e2e8f0;
        font-weight: 700;
        letter-spacing: .05em;
        font-size: 1.05rem;
      }

      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .rank {
        position: absolute;
        inset-block-start: -.42rem;
        inset-inline-start: -.42rem;
        width: 2.55rem;
        aspect-ratio: 1;
        border-radius: 999px;
        display: grid;
        place-items: center;
        background: var(--badge);
        color: #0f172a;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: .05em;
        box-shadow: 0 14px 30px var(--glow);
      }

      .leader[data-rank='1'] {
        border-color: rgba(250, 204, 21, .55);
        box-shadow: 0 26px 48px rgba(250, 204, 21, .22);
      }

      .leader[data-rank='1']::after {
        background: radial-gradient(circle at 20% 20%, rgba(250, 204, 21, .4), transparent 68%);
        opacity: .65;
      }

      .leader[data-rank='1'] .rank {
        background: linear-gradient(135deg, #fde047, #f97316);
        color: #1f2937;
      }

      .leader[data-rank='2'] {
        border-color: rgba(191, 219, 254, .4);
      }

      .leader[data-rank='2']::after {
        background: radial-gradient(circle at 20% 20%, rgba(191, 219, 254, .35), transparent 70%);
        opacity: .55;
      }

      .leader[data-rank='2'] .rank {
        background: linear-gradient(135deg, #dbeafe, #818cf8);
        color: #1e1b4b;
      }

      .leader[data-rank='3'] {
        border-color: rgba(251, 191, 217, .42);
      }

      .leader[data-rank='3']::after {
        background: radial-gradient(circle at 20% 20%, rgba(251, 191, 217, .35), transparent 70%);
        opacity: .55;
      }

      .leader[data-rank='3'] .rank {
        background: linear-gradient(135deg, #fbcfe8, #ec4899);
        color: #831843;
      }

      .leader-body {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: clamp(.55rem, 2vw, .9rem);
        align-items: center;
      }

      .identity {
        display: grid;
        gap: .35rem;
      }

      .identity strong {
        font-weight: 600;
        letter-spacing: .01em;
        font-size: 1rem;
      }

      .identity-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .35rem;
      }

      .meta-chip {
        display: inline-flex;
        align-items: center;
        gap: .3rem;
        font-size: .78rem;
        padding: .3rem .7rem;
        border-radius: 999px;
        background: var(--chip-bg);
        border: 1px solid var(--chip-border);
        color: var(--chip-text);
        letter-spacing: .02em;
      }

      .meta-chip i { font-style: normal; opacity: .85; font-size: .85rem; }

      .stat {
        display: grid;
        justify-items: end;
        gap: .18rem;
        padding-inline-start: clamp(.85rem, 3vw, 1.1rem);
        border-inline-start: 1px solid rgba(148, 163, 184, .28);
        text-align: end;
        min-width: 6.2rem;
      }

      .score {
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        letter-spacing: .05em;
        font-size: 1.18rem;
      }

      .score-label {
        font-size: .78rem;
        color: var(--muted);
        letter-spacing: .05em;
      }

      .status-text {
        margin: 0;
        font-size: .9rem;
        text-align: center;
        color: var(--muted);
      }

      .status-text.error { color: #fca5a5; }
      .status-text.success { color: #6ee7b7; }
      .status-text.warning { color: #fcd34d; }

      .placeholder {
        position: relative;
        overflow: hidden;
        color: transparent;
        border-radius: 12px;
        background: rgba(148, 163, 184, .18);
        min-width: 6ch;
        min-height: 1rem;
      }

      .placeholder::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, transparent 0%, rgba(226, 232, 240, .22) 45%, transparent 90%);
        animation: shimmer 1.6s linear infinite;
      }

      .leader-list > li { animation: fadeUp .48s var(--ease-spring) both; }
      .leader-list > li:nth-child(1) { animation-delay: .05s; }
      .leader-list > li:nth-child(2) { animation-delay: .08s; }
      .leader-list > li:nth-child(3) { animation-delay: .11s; }

      /* Keyframes */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
      @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: none; } }
      @keyframes rise { from { opacity: 0; transform: translateY(18px) scale(.96); } to { opacity: 1; transform: none; } }
      @keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }

      @media (max-width: 520px) {
        body { padding: clamp(.45rem, 4vw, .8rem); }
        .main-content { padding: clamp(.95rem, 4.2vw, 1.35rem); border-radius: 24px; }
        .switcher { width: 100%; }
        .leader { grid-template-columns: 1fr; justify-items: center; text-align: center; gap: .85rem; }
        .leader .portrait { padding: 0; }
        .leader-body { grid-template-columns: 1fr; justify-items: center; text-align: center; }
        .leader-body .stat {
          border: none;
          padding-inline-start: 0;
          justify-items: center;
          text-align: center;
        }
      }

      @media (max-width: 360px) {
        .main-content { padding: .85rem; border-radius: 22px; }
        .switcher { padding: .3rem; }
        .switch-btn { padding: .5rem .75rem; font-size: .88rem; }
        .rank { width: 2.35rem; }
        .avatar { width: 2.85rem; height: 2.85rem; }
      }

      @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    </style>
  </head>
  <body>
    <div class="app-background">
      <div class="app-shell" role="application">
        <main class="main-content" aria-live="polite">
          <header class="page-header hero">
            <div>
              <p id="page-subtitle" class="page-subtitle">همه آمار گیلد اینجاست؛ یک نگاه و بس! ✨</p>
              <h2 id="page-title" class="page-title">لیدربورد فلایزکس 🚀</h2>
            </div>
            <nav class="switcher" aria-label="انتخاب لیدربورد">
              <button id="btn-xp" type="button" class="switch-btn active">⚡️ قهرمانان XP</button>
              <button id="btn-cups" type="button" class="switch-btn">🏆 ستاره‌های جام</button>
            </nav>
          </header>

          <!-- XP Leaderboard -->
          <section id="route-xp" class="route active" tabindex="-1">
            <article class="data-card">
              <header class="card-header">
                <h3>۱۰ قهرمان برتر XP ⚡️</h3>
                <button type="button" id="xp-refresh" class="icon-button" aria-label="تازه‌سازی XP">⟳</button>
              </header>
              <ul id="xp-top-list" class="item-list leader-list" aria-live="polite"></ul>
              <p id="xp-status" class="status-text"></p>
            </article>
          </section>

          <!-- Cups Leaderboard -->
          <section id="route-cups" class="route" tabindex="-1" hidden>
            <article class="data-card">
              <header class="card-header">
                <h3>۱۰ قهرمان برتر جام 🏆</h3>
                <button type="button" id="cups-refresh" class="icon-button" aria-label="تازه‌سازی جام">⟳</button>
              </header>
              <ul id="cups-top-list" class="item-list leader-list" aria-live="polite"></ul>
              <p id="cups-status" class="status-text"></p>
            </article>
          </section>
        </main>
      </div>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const xpList = $('#xp-top-list');
      const cupsList = $('#cups-top-list');
      const xpStatus = $('#xp-status');
      const cupsStatus = $('#cups-status');

      let healthWarning = null;
      let healthBlocking = false;

      const clearStatus = (element) => {
        if (!element) return;
        element.classList.remove('error', 'success', 'warning');
      };

      const applyHealthWarning = () => {
        if (!healthWarning) {
          if (xpStatus) clearStatus(xpStatus);
          if (cupsStatus) clearStatus(cupsStatus);
          return false;
        }
        if (xpList) xpList.innerHTML = '';
        if (cupsList) cupsList.innerHTML = '';
        if (xpStatus) {
          clearStatus(xpStatus);
          xpStatus.textContent = healthWarning;
          xpStatus.classList.add('warning');
        }
        if (cupsStatus) {
          clearStatus(cupsStatus);
          cupsStatus.textContent = healthWarning;
          cupsStatus.classList.add('warning');
        }
        return true;
      };

      const setActive = (target) => {
        const xp = $('#route-xp');
        const cups = $('#route-cups');
        const bxp = $('#btn-xp');
        const bc = $('#btn-cups');
        if (target === 'xp') {
          xp.removeAttribute('hidden'); xp.classList.add('active');
          cups.setAttribute('hidden',''); cups.classList.remove('active');
          bxp.classList.add('active'); bc.classList.remove('active');
        } else {
          cups.removeAttribute('hidden'); cups.classList.add('active');
          xp.setAttribute('hidden',''); xp.classList.remove('active');
          bc.classList.add('active'); bxp.classList.remove('active');
        }
      };

      const metaChip = (icon, text) => {
        const chip = document.createElement('span');
        chip.className = 'meta-chip';
        const iconEl = document.createElement('i');
        iconEl.textContent = icon;
        chip.appendChild(iconEl);
        chip.appendChild(document.createTextNode(text));
        return chip;
      };

      const li = (rank, fullName, username, userId, value, label, avatarUrl) => {
        const item = document.createElement('li');
        item.className = 'leader';
        item.dataset.rank = rank;

        const portrait = document.createElement('div');
        portrait.className = 'portrait';

        const av = document.createElement('div');
        av.className = 'avatar';
        if (avatarUrl) {
          const img = document.createElement('img');
          img.alt = String(fullName || username || userId);
          img.src = avatarUrl;
          av.appendChild(img);
        } else {
          const initial = (String(fullName || username || 'کاربر').trim()[0] || '؟').toUpperCase();
          const span = document.createElement('span');
          span.textContent = initial;
          av.appendChild(span);
        }

        const r = document.createElement('span');
        r.className = 'rank';
        r.textContent = `#${rank}`;
        portrait.appendChild(av);
        portrait.appendChild(r);

        const leaderBody = document.createElement('div');
        leaderBody.className = 'leader-body';

        const identity = document.createElement('div');
        identity.className = 'identity';
        const t = document.createElement('strong');
        t.textContent = fullName || username || `کاربر ${userId}`;
        identity.appendChild(t);
        const meta = document.createElement('div');
        meta.className = 'identity-meta';
        if (username) {
          const cleaned = `@${String(username).replace(/^@+/, '')}`;
          meta.appendChild(metaChip('👤', cleaned));
        }
        meta.appendChild(metaChip('🆔', `#${userId}`));
        identity.appendChild(meta);

        const stat = document.createElement('div');
        stat.className = 'stat';
        const sc = document.createElement('span');
        sc.className = 'score';
        sc.textContent = value;
        const scLabel = document.createElement('span');
        scLabel.className = 'score-label';
        scLabel.textContent = label;
        stat.appendChild(sc);
        stat.appendChild(scLabel);

        leaderBody.appendChild(identity);
        leaderBody.appendChild(stat);

        item.appendChild(portrait);
        item.appendChild(leaderBody);
        return item;
      };

      const createPreviewItem = (rank, label) => {
        const item = document.createElement('li');
        item.className = 'leader preview';
        item.dataset.rank = rank;

        const portrait = document.createElement('div');
        portrait.className = 'portrait';

        const av = document.createElement('div');
        av.className = 'avatar';
        const avatarPlaceholder = document.createElement('span');
        avatarPlaceholder.className = 'placeholder';
        avatarPlaceholder.style.width = '100%';
        avatarPlaceholder.style.height = '100%';
        av.appendChild(avatarPlaceholder);

        const r = document.createElement('span');
        r.className = 'rank';
        r.textContent = `#${rank}`;
        portrait.appendChild(av);
        portrait.appendChild(r);

        const leaderBody = document.createElement('div');
        leaderBody.className = 'leader-body';

        const identity = document.createElement('div');
        identity.className = 'identity';
        const namePlaceholder = document.createElement('span');
        namePlaceholder.className = 'placeholder';
        namePlaceholder.style.width = '12ch';
        namePlaceholder.style.height = '1.1rem';
        const meta = document.createElement('div');
        meta.className = 'identity-meta';
        const metaPlaceholder = document.createElement('span');
        metaPlaceholder.className = 'placeholder';
        metaPlaceholder.style.width = '9ch';
        meta.appendChild(metaPlaceholder);
        identity.appendChild(namePlaceholder);
        identity.appendChild(meta);

        const stat = document.createElement('div');
        stat.className = 'stat';
        const statValue = document.createElement('span');
        statValue.className = 'placeholder';
        statValue.style.width = '6ch';
        const statLabel = document.createElement('span');
        statLabel.className = 'placeholder';
        statLabel.style.width = '5ch';
        stat.appendChild(statValue);
        stat.appendChild(statLabel);
        stat.setAttribute('aria-label', label);

        leaderBody.appendChild(identity);
        leaderBody.appendChild(stat);

        item.appendChild(portrait);
        item.appendChild(leaderBody);
        return item;
      };

      const renderPreviews = (element, label) => {
        if (!element) return;
        element.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (let i = 1; i <= 3; i += 1) {
          frag.appendChild(createPreviewItem(i, label));
        }
        element.appendChild(frag);
      };

      renderPreviews(xpList, 'XP');
      renderPreviews(cupsList, 'جام');

      const computeApiBasePath = () => {
        const override = window.__FLYZEXBOT_API_BASE_PATH__;
        if (typeof override === 'string' && override.trim()) {
          return override.trim().replace(/\/+$/, '');
        }
        try {
          const { pathname: rawPathname = '' } = window.location || {};
          const trimmedPath = rawPathname.replace(/\/+$/, '');
          if (!trimmedPath || trimmedPath === '/') {
            return '/api';
          }

          const segments = trimmedPath.split('/').filter(Boolean);
          if (!segments.length) {
            return '/api';
          }

          const lastSegment = segments[segments.length - 1];
          if (lastSegment && lastSegment.includes('.')) {
            segments.pop();
          }

          // If the static assets are served from /static, avoid inheriting that prefix for the API calls.
          if (segments[0] === 'static') {
            segments.shift();
          }

          const basePath = segments.length ? `/${segments.join('/')}` : '';
          return basePath ? `${basePath}/api` : '/api';
        } catch (error) {
          return '/api';
        }
      };

      const joinPaths = (base, segment = '') => {
        if (!segment) {
          return base || '/api';
        }
        const trimmed = segment.replace(/^\/+/, '');
        if (!base) {
          return `/${trimmed}`;
        }
        if (base.endsWith('/')) {
          return `${base}${trimmed}`;
        }
        return `${base}/${trimmed}`;
      };

      const apiBasePath = computeApiBasePath();
      const apiUrl = (path = '') => joinPaths(apiBasePath, path);

      const sanitizeMessage = (text) => {
        if (!text) return '';
        const withoutTags = text.replace(/<[^>]+>/g, ' ');
        const condensed = withoutTags.replace(/\s+/g, ' ').trim();
        if (condensed.length > 160) {
          return `${condensed.slice(0, 160)}…`;
        }
        return condensed;
      };

      const readErrorMessage = async (response, contentType) => {
        if (contentType.includes('application/json')) {
          try {
            const data = await response.json();
            return (
              data?.detail ||
              data?.message ||
              data?.error ||
              data?.status_text ||
              `خطای ${response.status || ''}`.trim()
            );
          } catch (error) {
            // Fall through to generic handling when JSON parsing fails
          }
        }
        try {
          const text = await response.text();
          const sanitized = sanitizeMessage(text);
          if (sanitized) {
            return sanitized;
          }
        } catch (error) {
          // Ignore body read errors and fall back to a generic message
        }
        if (response.status === 404) {
          return 'چیزی برای نمایش پیدا نشد.';
        }
        if (response.status) {
          return `کد خطا: ${response.status}`;
        }
        return 'در دریافت داده‌ها به مشکل خوردیم.';
      };

      const fetchJSON = async (url) => {
        let response;
        try {
          response = await fetch(url, { headers: { 'Accept': 'application/json' } });
        } catch (error) {
          throw new Error('اتصال برقرار نشد؛ لطفاً کمی بعد دوباره امتحان کن.');
        }

        const contentType = String(response.headers.get('content-type') || '').toLowerCase();
        if (!response.ok) {
          const message = await readErrorMessage(response, contentType);
          throw new Error(message || 'در گرفتن داده‌ها به مشکل خوردیم.');
        }

        if (!contentType.includes('application/json')) {
          throw new Error('پاسخی که گرفتیم قابل خواندن نبود.');
        }

        try {
          return await response.json();
        } catch (error) {
          throw new Error('نتوانستیم پاسخ سرور را پردازش کنیم.');
        }
      };

      const checkHealth = async () => {
        try {
          const status = await fetchJSON(apiUrl('health'));
          if (!status.storage_loaded) {
            healthWarning = 'داده‌ها بالا نمی‌آیند؛ لطفاً وضعیت سرویس ذخیره‌سازی را چک کنید.';
            healthBlocking = true;
          } else if (status.storage_read_only) {
            healthWarning = 'ذخیره‌سازی فقط خواندنی شده؛ تنظیمات مسیر یا دسترسی نوشتن را بررسی کنید.';
            healthBlocking = true;
          } else {
            healthWarning = null;
            healthBlocking = false;
          }
        } catch (error) {
          healthWarning = `نشد وضعیت سرویس را بگیریم: ${error.message || error}`;
          healthBlocking = false;
        }
        applyHealthWarning();
      };

      const loadXP = async () => {
        if (healthWarning) {
          if (applyHealthWarning() && healthBlocking) {
            return;
          }
        }
        clearStatus(xpStatus);
        xpStatus.textContent = '⚙️ در حال آماده‌سازی لیست هستیم...';
        renderPreviews(xpList, 'XP');
        try {
          const data = await fetchJSON(apiUrl('leaderboard/xp/top?limit=10'));
          const items = data.leaderboard || [];
          if (!items.length) { xpStatus.textContent = 'فعلاً آماری برای نمایش نداریم.'; xpList.innerHTML = ''; return; }
          xpStatus.textContent = '';
          xpList.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const e of items) {
            let avatarUrl = null;
            try {
              const p = await fetchJSON(apiUrl(`profile/${encodeURIComponent(e.user_id)}`));
              avatarUrl = p.avatar_url || null;
              e.full_name = e.full_name || p.full_name;
              e.username = e.username || p.username;
            } catch {}
            frag.appendChild(li(e.rank, e.full_name, e.username, e.user_id, e.xp, 'XP', avatarUrl));
          }
          xpList.appendChild(frag);
        } catch (err) {
          xpStatus.textContent = `مشکلی پیش اومد: ${err.message || err}`;
          xpStatus.classList.add('error');
          xpList.innerHTML = '';
        }
      };

      const loadCups = async () => {
        if (healthWarning) {
          if (applyHealthWarning() && healthBlocking) {
            return;
          }
        }
        clearStatus(cupsStatus);
        cupsStatus.textContent = '⚙️ در حال آماده‌سازی لیست هستیم...';
        renderPreviews(cupsList, 'جام');
        try {
          const data = await fetchJSON(apiUrl('leaderboard/cups/top?limit=10'));
          const items = data.leaderboard || [];
          if (!items.length) { cupsStatus.textContent = 'اینجا هنوز جامی ثبت نشده.'; cupsList.innerHTML = ''; return; }
          cupsStatus.textContent = '';
          cupsList.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const e of items) {
            let avatarUrl = null;
            try {
              const p = await fetchJSON(apiUrl(`profile/${encodeURIComponent(e.user_id)}`));
              avatarUrl = p.avatar_url || null;
              e.full_name = e.full_name || p.full_name;
              e.username = e.username || p.username;
            } catch {}
            frag.appendChild(li(e.rank, e.full_name, e.username, e.user_id, e.cups, 'جام', avatarUrl));
          }
          cupsList.appendChild(frag);
        } catch (err) {
          cupsStatus.textContent = `مشکلی پیش اومد: ${err.message || err}`;
          cupsStatus.classList.add('error');
          cupsList.innerHTML = '';
        }
      };

      $('#btn-xp').addEventListener('click', () => { setActive('xp'); loadXP(); });
      $('#btn-cups').addEventListener('click', () => { setActive('cups'); loadCups(); });
      $('#xp-refresh').addEventListener('click', loadXP);
      $('#cups-refresh').addEventListener('click', loadCups);

      const init = async () => {
        setActive('xp');
        await checkHealth();
        if (!healthWarning) {
          await loadXP();
        }
      };

      init();
    </script>
  </body>
</html>
