<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Flyzex Leaderboards</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="static/glass_panel.css" />
    <style>
      :root {
        --ease-spring: cubic-bezier(.2, .8, .2, 1);
        --badge: linear-gradient(135deg, #a855f7, #6366f1);
      }
      /* Layout */
      .app-shell { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main-content { max-width: 1100px; margin-inline: auto; }

      /* Header */
      .hero {
        display: grid;
        gap: .75rem;
        justify-items: start;
        animation: fadeIn .6s var(--ease-spring) both;
      }
      .hero > div { display: grid; gap: .4rem; }
      .switcher {
        display: grid;
        grid-auto-flow: column;
        gap: .35rem;
        padding: .35rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, .05);
        border: 1px solid rgba(148, 163, 184, .22);
        box-shadow: 0 10px 30px rgba(15, 23, 42, .25);
        justify-content: center;
        margin-inline: auto;
        width: min(100%, 340px);
      }
      .switch-btn {
        border: none;
        background: transparent;
        color: inherit;
        padding: .55rem 1.2rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: .95rem;
        font-weight: 600;
        letter-spacing: .01em;
        font-family: "Plus Jakarta Sans", "Vazirmatn", sans-serif;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .4rem;
        transition: background .25s var(--ease-spring), color .25s var(--ease-spring), transform .2s var(--ease-spring), box-shadow .25s var(--ease-spring);
      }
      .switch-btn:hover {
        transform: translateY(-1px);
      }
      .switch-btn:focus-visible {
        transform: translateY(-1px);
        outline: none;
        box-shadow: 0 0 0 3px rgba(148, 163, 184, .65);
      }
      .switch-btn.active {
        background: var(--badge);
        color: #0f172a;
        box-shadow: 0 12px 25px rgba(99, 102, 241, .35);
      }
      .switch-btn.active:focus-visible {
        box-shadow: 0 0 0 3px rgba(148, 163, 184, .65), 0 12px 25px rgba(99, 102, 241, .35);
      }

      /* Cards & animations */
      .data-card {
        animation: rise .55s var(--ease-spring) both;
      }
      .data-card:nth-of-type(2) { animation-delay: .09s; }
      .leader-list > li,
      #cups-list > article {
        animation: fadeUp .48s var(--ease-spring) both;
      }
      .leader-list > li:nth-child(1) { animation-delay: .05s; }
      .leader-list > li:nth-child(2) { animation-delay: .08s; }
      .leader-list > li:nth-child(3) { animation-delay: .11s; }

      .leader-list > li.leader {
        display: flex;
        gap: 1.2rem;
        align-items: center;
        position: relative;
        padding-block: 1.15rem;
        padding-inline: 1.35rem;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, .22);
        background: linear-gradient(140deg, rgba(15, 23, 42, .86), rgba(30, 41, 59, .68));
        box-shadow: 0 16px 32px rgba(8, 14, 35, .32);
      }
      .leader-list > li.leader .portrait {
        position: relative;
        display: grid;
        place-items: center;
        flex: 0 0 auto;
        padding-inline-end: .35rem;
      }
      .rank {
        position: absolute;
        inset-block-start: -.35rem;
        inset-inline-start: -.35rem;
        width: 2.5rem;
        aspect-ratio: 1;
        border-radius: 999px;
        display: grid;
        place-items: center;
        background: var(--badge);
        color: #0f172a;
        font-weight: 700;
        box-shadow: 0 14px 28px rgba(99, 102, 241, .35);
      }
      .avatar {
        width: 3rem;
        height: 3rem;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(79, 70, 229, .15), rgba(14, 165, 233, .15));
        display: grid;
        place-items: center;
        overflow: hidden;
        box-shadow: 0 10px 24px rgba(15, 23, 42, .35);
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .avatar span { font-weight: 700; opacity: .9; letter-spacing: .04em; }
      .leader-body {
        flex: 1 1 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.25rem;
      }
      .identity { display: flex; flex-direction: column; gap: .3rem; }
      .identity strong { font-weight: 600; letter-spacing: .01em; }
      .identity-meta { display: flex; flex-wrap: wrap; gap: .35rem; }
      .meta-chip {
        display: inline-flex;
        align-items: center;
        gap: .3rem;
        font-size: .78rem;
        padding: .25rem .65rem;
        border-radius: 999px;
        background: rgba(148, 163, 184, .16);
        border: 1px solid rgba(148, 163, 184, .22);
        color: rgba(226, 232, 240, .88);
        letter-spacing: .02em;
      }
      .meta-chip i { font-style: normal; opacity: .8; }
      .stat {
        display: flex;
        flex-direction: column;
        gap: .2rem;
        align-items: flex-end;
        text-align: end;
        margin-inline-start: auto;
        padding-inline-start: 1.25rem;
        border-inline-start: 1px solid rgba(148, 163, 184, .28);
        min-width: 6.5rem;
      }
      .score {
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        letter-spacing: .04em;
        font-size: 1.1rem;
      }
      .score-label { font-size: .78rem; color: rgba(203, 213, 225, .75); letter-spacing: .05em; }
      .leader.preview { opacity: .9; pointer-events: none; }
      .placeholder {
        position: relative;
        overflow: hidden;
        color: transparent;
        border-radius: 12px;
        background: rgba(148, 163, 184, .14);
        min-width: 6ch;
        min-height: 1rem;
      }
      .placeholder::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, transparent 0%, rgba(226, 232, 240, .18) 45%, transparent 90%);
        animation: shimmer 1.6s linear infinite;
      }

      /* Keyframes */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
      @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: none; } }
      @keyframes rise { from { opacity: 0; transform: translateY(18px) scale(.96); } to { opacity: 1; transform: none; } }
      @keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }

      @media (min-width: 900px) {
        .leaderboard-grid { grid-template-columns: repeat(2, minmax(340px, 1fr)); }
        .hero { justify-items: center; text-align: center; }
        .hero > div { text-align: center; }
        .main-content { max-width: 960px; width: 100%; }
      }
      @media (min-width: 1200px) {
        .main-content { max-width: 1024px; }
        .switcher { width: min(100%, 420px); }
      }
      @media (max-width: 768px) {
        body { padding: clamp(0.65rem, 2.5vw, 1.15rem); }
        .main-content {
          padding: clamp(1rem, 3.5vw, 1.45rem);
          width: 100%;
        }
      }
      @media (max-width: 540px) {
        body { padding: clamp(0.45rem, 3vw, 0.75rem); }
        .main-content { padding: clamp(0.85rem, 4vw, 1.2rem); }
        .data-card { padding: clamp(1.1rem, 4.5vw, 1.45rem); }
        .switcher { width: 100%; }
        .leader-list > li.leader {
          flex-direction: column;
          align-items: stretch;
          gap: 0.95rem;
          padding-inline: clamp(0.9rem, 4vw, 1.1rem);
        }
        .leader-list > li.leader .portrait {
          align-self: flex-start;
        }
        .leader-body {
          width: 100%;
          flex-direction: column;
          align-items: stretch;
          gap: .85rem;
        }
        .leader-body .stat {
          border: none;
          padding-inline-start: 0;
          margin-inline-start: 0;
          align-items: flex-start;
          text-align: start;
        }
      }
      @media (max-width: 420px) {
        .leader-list > li.leader .rank {
          inset-inline-start: -.2rem;
          inset-block-start: -.2rem;
        }
        .leader-body {
          gap: .75rem;
        }
        .leader-body .stat {
          align-items: center;
          text-align: center;
        }
      }
      @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    </style>
  </head>
  <body>
    <div class="app-background">
      <div class="app-shell" role="application">
        <main class="main-content" aria-live="polite">
          <header class="page-header hero">
            <div>
              <p id="page-subtitle" class="page-subtitle">همه آمار گیلد اینجاست؛ یک نگاه و بس! ✨</p>
              <h2 id="page-title" class="page-title">لیدربورد فلایزکس 🚀</h2>
            </div>
            <nav class="switcher" aria-label="انتخاب لیدربورد">
              <button id="btn-xp" type="button" class="switch-btn active">⚡️ قهرمانان XP</button>
              <button id="btn-cups" type="button" class="switch-btn">🏆 ستاره‌های جام</button>
            </nav>
          </header>

          <!-- XP Leaderboard -->
          <section id="route-xp" class="route active" tabindex="-1">
            <article class="data-card">
              <header class="card-header">
                <h3>۱۰ قهرمان برتر XP ⚡️</h3>
                <button type="button" id="xp-refresh" class="icon-button" aria-label="تازه‌سازی XP">⟳</button>
              </header>
              <ul id="xp-top-list" class="item-list leader-list" aria-live="polite"></ul>
              <p id="xp-status" class="status-text"></p>
            </article>
          </section>

          <!-- Cups Leaderboard -->
          <section id="route-cups" class="route" tabindex="-1" hidden>
            <article class="data-card">
              <header class="card-header">
                <h3>۱۰ قهرمان برتر جام 🏆</h3>
                <button type="button" id="cups-refresh" class="icon-button" aria-label="تازه‌سازی جام">⟳</button>
              </header>
              <ul id="cups-top-list" class="item-list leader-list" aria-live="polite"></ul>
              <p id="cups-status" class="status-text"></p>
            </article>
          </section>
        </main>
      </div>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const xpList = $('#xp-top-list');
      const cupsList = $('#cups-top-list');
      const xpStatus = $('#xp-status');
      const cupsStatus = $('#cups-status');

      let healthWarning = null;
      let healthBlocking = false;

      const clearStatus = (element) => {
        if (!element) return;
        element.classList.remove('error', 'success', 'warning');
      };

      const applyHealthWarning = () => {
        if (!healthWarning) {
          if (xpStatus) clearStatus(xpStatus);
          if (cupsStatus) clearStatus(cupsStatus);
          return false;
        }
        if (xpList) xpList.innerHTML = '';
        if (cupsList) cupsList.innerHTML = '';
        if (xpStatus) {
          clearStatus(xpStatus);
          xpStatus.textContent = healthWarning;
          xpStatus.classList.add('warning');
        }
        if (cupsStatus) {
          clearStatus(cupsStatus);
          cupsStatus.textContent = healthWarning;
          cupsStatus.classList.add('warning');
        }
        return true;
      };

      const setActive = (target) => {
        const xp = $('#route-xp');
        const cups = $('#route-cups');
        const bxp = $('#btn-xp');
        const bc = $('#btn-cups');
        if (target === 'xp') {
          xp.removeAttribute('hidden'); xp.classList.add('active');
          cups.setAttribute('hidden',''); cups.classList.remove('active');
          bxp.classList.add('active'); bc.classList.remove('active');
        } else {
          cups.removeAttribute('hidden'); cups.classList.add('active');
          xp.setAttribute('hidden',''); xp.classList.remove('active');
          bc.classList.add('active'); bxp.classList.remove('active');
        }
      };

      const metaChip = (icon, text) => {
        const chip = document.createElement('span');
        chip.className = 'meta-chip';
        const iconEl = document.createElement('i');
        iconEl.textContent = icon;
        chip.appendChild(iconEl);
        chip.appendChild(document.createTextNode(text));
        return chip;
      };

      const li = (rank, fullName, username, userId, value, label, avatarUrl) => {
        const item = document.createElement('li');
        item.className = 'leader';

        const portrait = document.createElement('div');
        portrait.className = 'portrait';

        const av = document.createElement('div');
        av.className = 'avatar';
        if (avatarUrl) {
          const img = document.createElement('img');
          img.alt = String(fullName || username || userId);
          img.src = avatarUrl;
          av.appendChild(img);
        } else {
          const initial = (String(fullName || username || 'کاربر').trim()[0] || '؟').toUpperCase();
          const span = document.createElement('span');
          span.textContent = initial;
          av.appendChild(span);
        }

        const r = document.createElement('span');
        r.className = 'rank';
        r.textContent = `#${rank}`;
        portrait.appendChild(av);
        portrait.appendChild(r);

        const leaderBody = document.createElement('div');
        leaderBody.className = 'leader-body';

        const identity = document.createElement('div');
        identity.className = 'identity';
        const t = document.createElement('strong');
        t.textContent = fullName || username || `کاربر ${userId}`;
        identity.appendChild(t);
        const meta = document.createElement('div');
        meta.className = 'identity-meta';
        if (username) {
          const cleaned = `@${String(username).replace(/^@+/, '')}`;
          meta.appendChild(metaChip('👤', cleaned));
        }
        meta.appendChild(metaChip('🆔', `#${userId}`));
        identity.appendChild(meta);

        const stat = document.createElement('div');
        stat.className = 'stat';
        const sc = document.createElement('span');
        sc.className = 'score';
        sc.textContent = value;
        const scLabel = document.createElement('span');
        scLabel.className = 'score-label';
        scLabel.textContent = label;
        stat.appendChild(sc);
        stat.appendChild(scLabel);

        leaderBody.appendChild(identity);
        leaderBody.appendChild(stat);

        item.appendChild(portrait);
        item.appendChild(leaderBody);
        return item;
      };

      const createPreviewItem = (rank, label) => {
        const item = document.createElement('li');
        item.className = 'leader preview';

        const portrait = document.createElement('div');
        portrait.className = 'portrait';

        const av = document.createElement('div');
        av.className = 'avatar';
        const avatarPlaceholder = document.createElement('span');
        avatarPlaceholder.className = 'placeholder';
        avatarPlaceholder.style.width = '100%';
        avatarPlaceholder.style.height = '100%';
        av.appendChild(avatarPlaceholder);

        const r = document.createElement('span');
        r.className = 'rank';
        r.textContent = `#${rank}`;
        portrait.appendChild(av);
        portrait.appendChild(r);

        const leaderBody = document.createElement('div');
        leaderBody.className = 'leader-body';

        const identity = document.createElement('div');
        identity.className = 'identity';
        const namePlaceholder = document.createElement('span');
        namePlaceholder.className = 'placeholder';
        namePlaceholder.style.width = '12ch';
        namePlaceholder.style.height = '1.1rem';
        const meta = document.createElement('div');
        meta.className = 'identity-meta';
        const metaPlaceholder = document.createElement('span');
        metaPlaceholder.className = 'placeholder';
        metaPlaceholder.style.width = '9ch';
        meta.appendChild(metaPlaceholder);
        identity.appendChild(namePlaceholder);
        identity.appendChild(meta);

        const stat = document.createElement('div');
        stat.className = 'stat';
        const statValue = document.createElement('span');
        statValue.className = 'placeholder';
        statValue.style.width = '6ch';
        const statLabel = document.createElement('span');
        statLabel.className = 'placeholder';
        statLabel.style.width = '5ch';
        stat.appendChild(statValue);
        stat.appendChild(statLabel);
        stat.setAttribute('aria-label', label);

        leaderBody.appendChild(identity);
        leaderBody.appendChild(stat);

        item.appendChild(portrait);
        item.appendChild(leaderBody);
        return item;
      };

      const renderPreviews = (element, label) => {
        if (!element) return;
        element.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (let i = 1; i <= 3; i += 1) {
          frag.appendChild(createPreviewItem(i, label));
        }
        element.appendChild(frag);
      };

      renderPreviews(xpList, 'XP');
      renderPreviews(cupsList, 'جام');

      const computeApiBasePath = () => {
        const override = window.__FLYZEXBOT_API_BASE_PATH__;
        if (typeof override === 'string' && override.trim()) {
          return override.trim().replace(/\/+$/, '');
        }
        try {
          const { pathname: rawPathname = '' } = window.location || {};
          const trimmedPath = rawPathname.replace(/\/+$/, '');
          if (!trimmedPath || trimmedPath === '/') {
            return '/api';
          }

          const segments = trimmedPath.split('/').filter(Boolean);
          if (!segments.length) {
            return '/api';
          }

          const lastSegment = segments[segments.length - 1];
          if (lastSegment && lastSegment.includes('.')) {
            segments.pop();
          }

          // If the static assets are served from /static, avoid inheriting that prefix for the API calls.
          if (segments[0] === 'static') {
            segments.shift();
          }

          const basePath = segments.length ? `/${segments.join('/')}` : '';
          return basePath ? `${basePath}/api` : '/api';
        } catch (error) {
          return '/api';
        }
      };

      const joinPaths = (base, segment = '') => {
        if (!segment) {
          return base || '/api';
        }
        const trimmed = segment.replace(/^\/+/, '');
        if (!base) {
          return `/${trimmed}`;
        }
        if (base.endsWith('/')) {
          return `${base}${trimmed}`;
        }
        return `${base}/${trimmed}`;
      };

      const apiBasePath = computeApiBasePath();
      const apiUrl = (path = '') => joinPaths(apiBasePath, path);

      const sanitizeMessage = (text) => {
        if (!text) return '';
        const withoutTags = text.replace(/<[^>]+>/g, ' ');
        const condensed = withoutTags.replace(/\s+/g, ' ').trim();
        if (condensed.length > 160) {
          return `${condensed.slice(0, 160)}…`;
        }
        return condensed;
      };

      const readErrorMessage = async (response, contentType) => {
        if (contentType.includes('application/json')) {
          try {
            const data = await response.json();
            return (
              data?.detail ||
              data?.message ||
              data?.error ||
              data?.status_text ||
              `خطای ${response.status || ''}`.trim()
            );
          } catch (error) {
            // Fall through to generic handling when JSON parsing fails
          }
        }
        try {
          const text = await response.text();
          const sanitized = sanitizeMessage(text);
          if (sanitized) {
            return sanitized;
          }
        } catch (error) {
          // Ignore body read errors and fall back to a generic message
        }
        if (response.status === 404) {
          return 'چیزی برای نمایش پیدا نشد.';
        }
        if (response.status) {
          return `کد خطا: ${response.status}`;
        }
        return 'در دریافت داده‌ها به مشکل خوردیم.';
      };

      const fetchJSON = async (url) => {
        let response;
        try {
          response = await fetch(url, { headers: { 'Accept': 'application/json' } });
        } catch (error) {
          throw new Error('اتصال برقرار نشد؛ لطفاً کمی بعد دوباره امتحان کن.');
        }

        const contentType = String(response.headers.get('content-type') || '').toLowerCase();
        if (!response.ok) {
          const message = await readErrorMessage(response, contentType);
          throw new Error(message || 'در گرفتن داده‌ها به مشکل خوردیم.');
        }

        if (!contentType.includes('application/json')) {
          throw new Error('پاسخی که گرفتیم قابل خواندن نبود.');
        }

        try {
          return await response.json();
        } catch (error) {
          throw new Error('نتوانستیم پاسخ سرور را پردازش کنیم.');
        }
      };

      const checkHealth = async () => {
        try {
          const status = await fetchJSON(apiUrl('health'));
          if (!status.storage_loaded) {
            healthWarning = 'داده‌ها بالا نمی‌آیند؛ لطفاً وضعیت سرویس ذخیره‌سازی را چک کنید.';
            healthBlocking = true;
          } else if (status.storage_read_only) {
            healthWarning = 'ذخیره‌سازی فقط خواندنی شده؛ تنظیمات مسیر یا دسترسی نوشتن را بررسی کنید.';
            healthBlocking = true;
          } else {
            healthWarning = null;
            healthBlocking = false;
          }
        } catch (error) {
          healthWarning = `نشد وضعیت سرویس را بگیریم: ${error.message || error}`;
          healthBlocking = false;
        }
        applyHealthWarning();
      };

      const loadXP = async () => {
        if (healthWarning) {
          if (applyHealthWarning() && healthBlocking) {
            return;
          }
        }
        clearStatus(xpStatus);
        xpStatus.textContent = '⚙️ در حال آماده‌سازی لیست هستیم...';
        renderPreviews(xpList, 'XP');
        try {
          const data = await fetchJSON(apiUrl('leaderboard/xp/top?limit=10'));
          const items = data.leaderboard || [];
          if (!items.length) { xpStatus.textContent = 'فعلاً آماری برای نمایش نداریم.'; xpList.innerHTML = ''; return; }
          xpStatus.textContent = '';
          xpList.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const e of items) {
            let avatarUrl = null;
            try {
              const p = await fetchJSON(apiUrl(`profile/${encodeURIComponent(e.user_id)}`));
              avatarUrl = p.avatar_url || null;
              e.full_name = e.full_name || p.full_name;
              e.username = e.username || p.username;
            } catch {}
            frag.appendChild(li(e.rank, e.full_name, e.username, e.user_id, e.xp, 'XP', avatarUrl));
          }
          xpList.appendChild(frag);
        } catch (err) {
          xpStatus.textContent = `مشکلی پیش اومد: ${err.message || err}`;
          xpStatus.classList.add('error');
          xpList.innerHTML = '';
        }
      };

      const loadCups = async () => {
        if (healthWarning) {
          if (applyHealthWarning() && healthBlocking) {
            return;
          }
        }
        clearStatus(cupsStatus);
        cupsStatus.textContent = '⚙️ در حال آماده‌سازی لیست هستیم...';
        renderPreviews(cupsList, 'جام');
        try {
          const data = await fetchJSON(apiUrl('leaderboard/cups/top?limit=10'));
          const items = data.leaderboard || [];
          if (!items.length) { cupsStatus.textContent = 'اینجا هنوز جامی ثبت نشده.'; cupsList.innerHTML = ''; return; }
          cupsStatus.textContent = '';
          cupsList.innerHTML = '';
          const frag = document.createDocumentFragment();
          for (const e of items) {
            let avatarUrl = null;
            try {
              const p = await fetchJSON(apiUrl(`profile/${encodeURIComponent(e.user_id)}`));
              avatarUrl = p.avatar_url || null;
              e.full_name = e.full_name || p.full_name;
              e.username = e.username || p.username;
            } catch {}
            frag.appendChild(li(e.rank, e.full_name, e.username, e.user_id, e.cups, 'جام', avatarUrl));
          }
          cupsList.appendChild(frag);
        } catch (err) {
          cupsStatus.textContent = `مشکلی پیش اومد: ${err.message || err}`;
          cupsStatus.classList.add('error');
          cupsList.innerHTML = '';
        }
      };

      $('#btn-xp').addEventListener('click', () => { setActive('xp'); loadXP(); });
      $('#btn-cups').addEventListener('click', () => { setActive('cups'); loadCups(); });
      $('#xp-refresh').addEventListener('click', loadXP);
      $('#cups-refresh').addEventListener('click', loadCups);

      const init = async () => {
        setActive('xp');
        await checkHealth();
        if (!healthWarning) {
          await loadXP();
        }
      };

      init();
    </script>
  </body>
</html>
